<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://apis.google.com/js/client.js"></script>
  <script src="./upload.js"></script>
  <title>Record self</title>

 
</head>
<body>
 
  <div style='display:flex; flex-direction: column; height:25%'>
    <video id='video' style='height:50vh; display: inline-block; margin:auto' autoplay muted='true'></video>

  
<div style='display: inline-block; margin:auto; margin-top: 20px;'>
    <button id='start'>
      Start Recording
    </button>
    <button id='stop'>
      Stop Recording
    </button>
    <button id='play'>
      Play
    </button>
    <button id='redo'>
      Re-record
    </button>
    <ul id='ul'>
      Downloads List:
    </ul>
  
  </div>
  </div>
  <script>
    var video, reqBtn, startBtn, stopBtn, ul, stream, recorder, recordedChunks;
video = document.getElementById('video');
reqBtn = document.getElementById('request');
startBtn = document.getElementById('start');
stopBtn = document.getElementById('stop');
playBtn = document.getElementById('play');
redoBtn = document.getElementById('redo');
ul = document.getElementById('ul');
document.onload = requestVideo();
startBtn.onclick = startRecording;
stopBtn.onclick = stopRecording;
playBtn.onclick = playRecording;
redoBtn.onclick = requestVideo;
startBtn.disabled = true;
ul.style.display = 'none';
stopBtn.disabled = true;

function requestVideo() {
  navigator.mediaDevices.getUserMedia({
      video: true,
      audio: true
    })
    .then(stm => {
      stream = stm;
      startBtn.removeAttribute('disabled');
      video.srcObject = new MediaStream(stream);
    }).catch(e => console.error(e));
}

function startRecording() {
  recordedChunks = [];
  recorder = new MediaRecorder(stream, {
    mimeType: 'video/webm;codecs=vp9'
  });
  recorder.ondataavailable = handleDataAvailable;
  recorder.start();
  stopBtn.removeAttribute('disabled');
  startBtn.disabled = true;

  function handleDataAvailable(event) {
  if (event.data.size > 0) {
    recordedChunks.push(event.data);
  } else {
    // ...
  }
}
}

function playRecording() {
  var superBuffer = new Blob(recordedChunks);
  video.srcObject=null;
    video.src = window.URL.createObjectURL(superBuffer);
}




function stopRecording() {

    var blob = new Blob(recordedChunks, {
      type: 'video/webm'
    });
    var url = URL.createObjectURL(blob);
    var name = ['video_', (new Date() + '').slice(4, 28), '.webm'].join('');
    uploadFile(url,name);
    ul.style.display = 'block';
    var a = document.createElement('a'),
      li = document.createElement('li');
    a.download = name;
    a.href = url;
    a.textContent = a.download;
    li.appendChild(a);
    ul.appendChild(li);
    window.URL.revokeObjectURL(url);

  recorder.stop();
  startBtn.removeAttribute('disabled');
  stopBtn.disabled = true;
}
  </script>
</body>
</html>