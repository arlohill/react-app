{"ast":null,"code":"var _jsxFileName = \"/Users/arlosb/Documents/GitHub/new react app/test3/src/components/Call/Call.js\";\nimport React, { useEffect, useContext, useReducer, useCallback, useState } from 'react';\nimport './Call.css';\nimport Tile from '../Tile/Tile';\nimport CallObjectContext from '../../CallObjectContext';\nimport MyContext from '../../MyContext'; // import SessionContext from '../../SessionContext';\n\nimport CallMessage from '../CallMessage/CallMessage';\nimport { initialCallState, CLICK_ALLOW_TIMEOUT, PARTICIPANTS_CHANGE, CAM_OR_MIC_ERROR, FATAL_ERROR, callReducer, isLocal, isScreenShare, containsScreenShare, getMessage } from './callState';\nimport { logDailyEvent } from '../../logUtils';\nimport setSubscriptions from '../../hooks/setSubscriptions';\n\nfunction useForceUpdate() {\n  const [value, setValue] = useState(0); // integer state\n\n  return () => setValue(value => value + 1); // update the state to force render\n}\n\nexport default function Call() {\n  const callObject = useContext(CallObjectContext); // const [ sessionState, setSessionState ] = useContext(SessionContext);\n  // const [ myInfo, setMyInfo ] = useContext(MyInfoContext);\n\n  const [callState, dispatch] = useReducer(callReducer, initialCallState);\n  const forceUpdate = useForceUpdate();\n  const {\n    myState\n  } = useContext(MyContext);\n  const [my, setMy] = myState;\n\n  window.updateCall = () => {\n    forceUpdate();\n  };\n  /**\n   * Start listening for participant changes, when the callObject is set.\n   */\n\n\n  useEffect(() => {\n    if (!callObject) return;\n    const events = ['participant-joined', 'participant-updated', 'participant-left'];\n\n    function handleNewParticipantsState(e) {\n      e && logDailyEvent(e);\n      dispatch({\n        type: PARTICIPANTS_CHANGE,\n        participants: callObject.participants()\n      });\n\n      if (e && e.action != 'participant-updated') {\n        setSubscriptions(callObject);\n        console.log(\"setting subscriptions because: \" + e.action);\n        let thisUserName = e.participant.user_name;\n        let thisSessionID = e.participant.session_id;\n        window.events = [];\n\n        if (e.action == \"participant-joined\") {\n          window.events.push(e);\n          updateUserList();\n        } else if (e.action == \"participant-left\") {\n          //remove from userList\n          let index = window.userList.indexOf(thisUserName);\n\n          if (index > -1) {\n            window.userList.splice(index, 1);\n          }\n\n          window.myIndex = window.userList.indexOf(my.name);\n          window.userListWithoutMe = [...window.userList];\n          window.userListWithoutMe.splice(window.myIndex, 1);\n\n          if (!window.userList.some(e => e.includes('_Admin')) //no one labeled admin\n          || my.name.includes('_Admin') && !window.userListWithoutMe.some(e => e.includes('_Admin')) // only I'm labeled admin\n          ) {\n              window.adminPresent = false;\n            } else {\n            console.log('******that test did not pass');\n            console.log(`UserList is: ${window.userList}`);\n            console.log(`UserListWithoutMe is: ${window.userListWithoutMe}`);\n            console.log(`!window.userList.some(e=>e.includes('_Admin')): ${!window.userList.some(e => e.includes('_Admin'))}`);\n            console.log(`(my.name.includes('_Admin') && !window.userListWithoutMe.some(e=>e.includes('_Admin')): ${my.name.includes('_Admin') && !window.userListWithoutMe.some(e => e.includes('_Admin'))}`);\n            console.log(`(my.name.includes('_Admin'): ${my.name.includes('_Admin')}`);\n            console.log(`!window.userListWithoutMe.some(e=>e.includes('_Admin')): ${!window.userListWithoutMe.some(e => e.includes('_Admin'))}`);\n          }\n\n          ;\n        }\n\n        function updateUserList() {\n          window.adminPresent = false;\n          let ps = callObject.participants();\n          window.userList = [];\n\n          for (const p in ps) {\n            let thisUserName = ps[p].user_name;\n            let thisSessionId = ps[p].session_id;\n            window.userList.push(thisUserName); //add  each user_name to UserList\n\n            window[thisUserName + '_SessionID'] = thisSessionId;\n\n            if (thisUserName.includes('_Admin') && p !== 'local') {\n              console.log('THERES AN ADMIN PRESENT!');\n              window.adminPresent = true;\n            }\n          }\n\n          ;\n          window.userList.sort(); //alphebetize that list\n\n          console.log('********Adding user to list: ' + thisUserName);\n          let userString = '';\n\n          for (const user of window.userList) {\n            userString += `${user},`;\n          }\n\n          console.log(`now the userList is: ${userString}`);\n\n          if (typeof window.updateAdminPanel !== 'undefined') {\n            window.updateAdminPanel();\n          }\n\n          ;\n        }\n\n        console.log('Admin present: ' + window.adminPresent);\n        console.log('UserList: ' + window.userList);\n      }\n    } // Use initial state\n\n\n    handleNewParticipantsState(); // Listen for changes in state\n\n    for (const event of events) {\n      callObject.on(event, handleNewParticipantsState); // callObject.on(\"joined-meeting\",()=>{\n      //     callObject.setUserName('testName');\n      //     console.log(`********Setting my user name as ${'TestName'}`);\n      // })\n    } // Stop listening for changes in state\n\n\n    return function cleanup() {\n      for (const event of events) {\n        callObject.off(event, handleNewParticipantsState);\n      }\n    };\n  }, [callObject]);\n  /**\n   * Start listening for call errors, when the callObject is set.\n   */\n\n  useEffect(() => {\n    if (!callObject) return;\n\n    function handleCameraErrorEvent(event) {\n      logDailyEvent(event);\n      dispatch({\n        type: CAM_OR_MIC_ERROR,\n        message: event && event.errorMsg && event.errorMsg.errorMsg || 'Unknown'\n      });\n    } // We're making an assumption here: there is no camera error when callObject\n    // is first assigned.\n\n\n    callObject.on('camera-error', handleCameraErrorEvent);\n    return function cleanup() {\n      callObject.off('camera-error', handleCameraErrorEvent);\n    };\n  }, [callObject]);\n  /**\n   * Start listening for fatal errors, when the callObject is set.\n   */\n\n  useEffect(() => {\n    if (!callObject) return;\n\n    function handleErrorEvent(e) {\n      logDailyEvent(e);\n      dispatch({\n        type: FATAL_ERROR,\n        message: e && e.errorMsg || 'Unknown'\n      });\n    } // We're making an assumption here: there is no error when callObject is\n    // first assigned.\n\n\n    callObject.on('error', handleErrorEvent);\n    return function cleanup() {\n      callObject.off('error', handleErrorEvent);\n    };\n  }, [callObject]);\n  /**\n   * Start a timer to show the \"click allow\" message, when the component mounts.\n   */\n\n  useEffect(() => {\n    const t = setTimeout(() => {\n      dispatch({\n        type: CLICK_ALLOW_TIMEOUT\n      });\n    }, 2500);\n    return function cleanup() {\n      clearTimeout(t);\n    };\n  }, []);\n  const numberOfSubs = window.currentSubs && window.currentSubs.filter(function (str) {\n    return str.indexOf('_AUDIO') === -1;\n  }).filter(function (str) {\n    return str.indexOf('_AUDIO') === -1;\n  }).filter(function (str) {\n    return str.indexOf(window.myName) === -1;\n  }).length; //number of subs, not counting audio-only or my name\n\n  useEffect(() => {\n    window.numberOfSubs = numberOfSubs;\n  }, [numberOfSubs]);\n\n  function getTiles() {\n    let largeTiles = [];\n    let smallTiles = [];\n    Object.entries(callState.callItems).forEach(([id, callItem]) => {\n      const isAudioOnly = () => {\n        if (!callItem.audioTrackState || !callItem.videoTrackState) {\n          return;\n        }\n\n        return callItem.audioTrackState.subscribed && !callItem.videoTrackState.subscribed;\n      };\n\n      const isLarge = isScreenShare(id) || !isLocal(id) && !containsScreenShare(callState.callItems) || isLocal(id) && numberOfSubs && numberOfSubs > 1 && !containsScreenShare(callState.callItems); //videoTrackState()\n\n      const tile = /*#__PURE__*/React.createElement(Tile, {\n        key: id,\n        videoTrackState: callItem.videoTrackState,\n        audioTrackState: callItem.audioTrackState,\n        isLocalPerson: isLocal(id),\n        isAudioOnly: isAudioOnly(),\n        isLarge: isLarge,\n        disableCornerMessage: isScreenShare(id),\n        isScreenShare: isScreenShare(id) // onClick={\n        //   isLocal(id)\n        //     ? null\n        //     : () => {\n        //         sendHello(id);\n        //       }\n        // }\n        ,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 247,\n          columnNumber: 9\n        }\n      });\n\n      if (isLarge) {\n        largeTiles.push(tile);\n      } else {\n        smallTiles.push(tile);\n      }\n    });\n    return [largeTiles, smallTiles];\n  }\n\n  const [largeTiles, smallTiles] = getTiles();\n  /**\n   * DELETE: Attached tiles objects to window for debugging purposes.\n   */\n\n  useEffect(() => {\n    // console.log('re-rendered');\n    // console.log('Userlist: ' + window.userList);\n    window.largeTiles = largeTiles;\n    window.smallTales = smallTiles;\n\n    window.add = function (n = 1) {\n      for (let i = 0; i < n; i++) {\n        callObject.addFakeParticipant();\n      }\n    };\n  }); // attach callState to window for debugging\n\n  useEffect(() => {\n    window.callState = callState;\n  }, [callState]);\n  const message = getMessage(callState);\n  return /*#__PURE__*/React.createElement(\"div\", {\n    className: window.amAdmin ? \"call-with-sidebar\" : \"call\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 303,\n      columnNumber: 5\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    className: `large-tiles count-${containsScreenShare(callState.callItems) && '1' || numberOfSubs && numberOfSubs + 1}`,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 305,\n      columnNumber: 7\n    }\n  }, !message ? largeTiles : null\n  /* Avoid showing large tiles to make room for the message */\n  ), /*#__PURE__*/React.createElement(\"div\", {\n    className: \"small-tiles\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 312,\n      columnNumber: 7\n    }\n  }, smallTiles), message && /*#__PURE__*/React.createElement(CallMessage, {\n    header: message.header,\n    detail: message.detail,\n    isError: message.isError,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 314,\n      columnNumber: 9\n    }\n  }));\n}","map":{"version":3,"sources":["/Users/arlosb/Documents/GitHub/new react app/test3/src/components/Call/Call.js"],"names":["React","useEffect","useContext","useReducer","useCallback","useState","Tile","CallObjectContext","MyContext","CallMessage","initialCallState","CLICK_ALLOW_TIMEOUT","PARTICIPANTS_CHANGE","CAM_OR_MIC_ERROR","FATAL_ERROR","callReducer","isLocal","isScreenShare","containsScreenShare","getMessage","logDailyEvent","setSubscriptions","useForceUpdate","value","setValue","Call","callObject","callState","dispatch","forceUpdate","myState","my","setMy","window","updateCall","events","handleNewParticipantsState","e","type","participants","action","console","log","thisUserName","participant","user_name","thisSessionID","session_id","push","updateUserList","index","userList","indexOf","splice","myIndex","name","userListWithoutMe","some","includes","adminPresent","ps","p","thisSessionId","sort","userString","user","updateAdminPanel","event","on","cleanup","off","handleCameraErrorEvent","message","errorMsg","handleErrorEvent","t","setTimeout","clearTimeout","numberOfSubs","currentSubs","filter","str","myName","length","getTiles","largeTiles","smallTiles","Object","entries","callItems","forEach","id","callItem","isAudioOnly","audioTrackState","videoTrackState","subscribed","isLarge","tile","smallTales","add","n","i","addFakeParticipant","amAdmin","header","detail","isError"],"mappings":"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","sourcesContent":["import React, { useEffect, useContext, useReducer, useCallback, useState } from 'react';\nimport './Call.css';\nimport Tile from '../Tile/Tile';\nimport CallObjectContext from '../../CallObjectContext';\nimport MyContext from '../../MyContext';\n// import SessionContext from '../../SessionContext';\nimport CallMessage from '../CallMessage/CallMessage';\nimport {\n  initialCallState,\n  CLICK_ALLOW_TIMEOUT,\n  PARTICIPANTS_CHANGE,\n  CAM_OR_MIC_ERROR,\n  FATAL_ERROR,\n  callReducer,\n  isLocal,\n  isScreenShare,\n  containsScreenShare,\n  getMessage,\n} from './callState';\nimport { logDailyEvent } from '../../logUtils';\nimport setSubscriptions from '../../hooks/setSubscriptions';\nfunction useForceUpdate(){\n  const [value, setValue] = useState(0); // integer state\n  return () => setValue(value => value + 1); // update the state to force render\n}\n\nexport default function Call() {\n  const callObject = useContext(CallObjectContext);\n  // const [ sessionState, setSessionState ] = useContext(SessionContext);\n  // const [ myInfo, setMyInfo ] = useContext(MyInfoContext);\n  const [callState, dispatch] = useReducer(callReducer, initialCallState);\n  const forceUpdate = useForceUpdate();\n  const { myState } = useContext(MyContext);\n  const [ my,setMy] = myState;\n\n\n  window.updateCall = () => {\n    forceUpdate();\n  }\n\n  /**\n   * Start listening for participant changes, when the callObject is set.\n   */\n  useEffect(() => {\n    if (!callObject) return;\n\n    const events = [\n      'participant-joined',\n      'participant-updated',\n      'participant-left',\n    ];\n\n   \n\n    function handleNewParticipantsState(e) {\n      e && logDailyEvent(e);\n      dispatch({\n        type: PARTICIPANTS_CHANGE,\n        participants: callObject.participants(),\n      });\n      if(e && e.action!='participant-updated') {\n        setSubscriptions(callObject);\n        console.log(\"setting subscriptions because: \" + e.action);\n          \n          let thisUserName = e.participant.user_name;\n          let thisSessionID = e.participant.session_id;\n          window.events=[];\n\n          if (e.action==\"participant-joined\") {\n            window.events.push(e);\n            updateUserList();\n\n\n            \n            \n          } else if (e.action==\"participant-left\") {\n            //remove from userList\n            let index = window.userList.indexOf(thisUserName);\n            if (index > -1) {\n            window.userList.splice(index, 1);\n            }\n            window.myIndex = window.userList.indexOf(my.name);\n            window.userListWithoutMe = [...window.userList];\n            window.userListWithoutMe.splice(window.myIndex, 1);\n            if (\n                !window.userList.some(e=>e.includes('_Admin'))   //no one labeled admin\n                || (my.name.includes('_Admin') && !window.userListWithoutMe.some(e=>e.includes('_Admin'))) // only I'm labeled admin\n                ) {\n              window.adminPresent=false;\n            } else {\n              console.log('******that test did not pass');\n              console.log(`UserList is: ${window.userList}`);\n              console.log(`UserListWithoutMe is: ${window.userListWithoutMe}`);\n              console.log(`!window.userList.some(e=>e.includes('_Admin')): ${!window.userList.some(e=>e.includes('_Admin'))}`);\n              console.log(`(my.name.includes('_Admin') && !window.userListWithoutMe.some(e=>e.includes('_Admin')): ${(my.name.includes('_Admin') && !window.userListWithoutMe.some(e=>e.includes('_Admin')))}`);\n              console.log(`(my.name.includes('_Admin'): ${(my.name.includes('_Admin'))}`);\n              console.log(`!window.userListWithoutMe.some(e=>e.includes('_Admin')): ${!window.userListWithoutMe.some(e=>e.includes('_Admin'))}`);\n            };\n           \n          }\n\n          function updateUserList() {\n            window.adminPresent=false;\n            let ps=callObject.participants(); \n            window.userList=[]; \n            for (const p in ps) {\n              let thisUserName = ps[p].user_name;\n              let thisSessionId = ps[p].session_id;\n              window.userList.push(thisUserName);      //add  each user_name to UserList\n              window[thisUserName+'_SessionID'] = thisSessionId;\n              if (thisUserName.includes('_Admin') && p!=='local') {\n                console.log('THERES AN ADMIN PRESENT!')\n                window.adminPresent=true;\n              }\n            }; \n            window.userList.sort();       //alphebetize that list\n            console.log('********Adding user to list: ' + thisUserName);\n            let userString = '';\n            for (const user of window.userList) {\n              userString += `${user},`\n            }\n            console.log(`now the userList is: ${userString}`);\n            if(typeof(window.updateAdminPanel)!=='undefined') {window.updateAdminPanel()};\n          }\n\n          \n\n          console.log('Admin present: ' + window.adminPresent);\n          console.log('UserList: ' + window.userList);\n      }\n      \n    }\n\n    // Use initial state\n    handleNewParticipantsState();\n\n    // Listen for changes in state\n    for (const event of events) {\n      callObject.on(event, handleNewParticipantsState);\n      // callObject.on(\"joined-meeting\",()=>{\n\n      //     callObject.setUserName('testName');\n      //     console.log(`********Setting my user name as ${'TestName'}`);\n\n      // })\n    }\n\n    // Stop listening for changes in state\n    return function cleanup() {\n      for (const event of events) {\n        callObject.off(event, handleNewParticipantsState);\n      }\n    };\n  }, [callObject]);\n\n  /**\n   * Start listening for call errors, when the callObject is set.\n   */\n  useEffect(() => {\n    if (!callObject) return;\n\n    function handleCameraErrorEvent(event) {\n      logDailyEvent(event);\n      dispatch({\n        type: CAM_OR_MIC_ERROR,\n        message:\n          (event && event.errorMsg && event.errorMsg.errorMsg) || 'Unknown',\n      });\n    }\n\n    // We're making an assumption here: there is no camera error when callObject\n    // is first assigned.\n\n    callObject.on('camera-error', handleCameraErrorEvent);\n\n    return function cleanup() {\n      callObject.off('camera-error', handleCameraErrorEvent);\n    };\n  }, [callObject]);\n\n  /**\n   * Start listening for fatal errors, when the callObject is set.\n   */\n  useEffect(() => {\n    if (!callObject) return;\n\n    function handleErrorEvent(e) {\n      logDailyEvent(e);\n      dispatch({\n        type: FATAL_ERROR,\n        message: (e && e.errorMsg) || 'Unknown',\n      });\n    }\n\n    // We're making an assumption here: there is no error when callObject is\n    // first assigned.\n\n    callObject.on('error', handleErrorEvent);\n\n    return function cleanup() {\n      callObject.off('error', handleErrorEvent);\n    };\n  }, [callObject]);\n\n  /**\n   * Start a timer to show the \"click allow\" message, when the component mounts.\n   */\n  useEffect(() => {\n    const t = setTimeout(() => {\n      dispatch({ type: CLICK_ALLOW_TIMEOUT });\n    }, 2500);\n\n    return function cleanup() {\n      clearTimeout(t);\n    };\n  }, []);\n\n  const numberOfSubs = window.currentSubs && window.currentSubs.filter(function (str) {return str.indexOf('_AUDIO') === -1}).filter(function (str) {return str.indexOf('_AUDIO') === -1}).filter(function (str) {return str.indexOf(window.myName) === -1}).length //number of subs, not counting audio-only or my name\n\n\n  useEffect(()=>{\nwindow.numberOfSubs =numberOfSubs;\n  },[numberOfSubs])\n\n\n\n \n\n  function getTiles() {\n    let largeTiles = [];\n    let smallTiles = [];\n    Object.entries(callState.callItems).forEach(([id, callItem]) => {\n\n\n      const isAudioOnly = () => {\n        if(!callItem.audioTrackState || !callItem.videoTrackState) {return}\n        return (callItem.audioTrackState.subscribed && !callItem.videoTrackState.subscribed);\n      }\n\n      const isLarge =\n        isScreenShare(id) ||\n        (!isLocal(id) && !containsScreenShare(callState.callItems)) \n        || (isLocal(id) && numberOfSubs && numberOfSubs>1 && !containsScreenShare(callState.callItems))   //videoTrackState()\n\n        \n      const tile = (\n        <Tile\n          key={id}\n          videoTrackState={callItem.videoTrackState}\n          audioTrackState={callItem.audioTrackState}\n          isLocalPerson={isLocal(id)}\n          isAudioOnly={isAudioOnly()}\n          isLarge={isLarge}\n          disableCornerMessage={isScreenShare(id)}\n          isScreenShare={isScreenShare(id)}\n          // onClick={\n          //   isLocal(id)\n          //     ? null\n          //     : () => {\n          //         sendHello(id);\n          //       }\n          // }\n        />\n      );\n      if (isLarge) {\n        largeTiles.push(tile);\n      } else {\n        smallTiles.push(tile);\n      }\n    });\n    \n    return [largeTiles, smallTiles];\n  }\n\n  const [largeTiles, smallTiles] = getTiles();\n\n  \n  /**\n   * DELETE: Attached tiles objects to window for debugging purposes.\n   */\n  useEffect(() => {\n    // console.log('re-rendered');\n    // console.log('Userlist: ' + window.userList);\n    window.largeTiles = largeTiles;\n    window.smallTales = smallTiles;\n    window.add = function(n=1) {\n      for(let i=0;i<n;i++) {\n        callObject.addFakeParticipant()\n      }\n    };\n    \n  }); \n\n\n   // attach callState to window for debugging\n   useEffect(() => {\n    window.callState = callState;\n  }, [callState]); \n\n\n  const message = getMessage(callState);\n  return (\n    <div className={window.amAdmin ? \"call-with-sidebar\" : \"call\"}>\n                                      {/* add # of tiles to class name. alternative: {largeTiles.length}*/}\n      <div className={`large-tiles count-${(containsScreenShare(callState.callItems)&&'1')||numberOfSubs && numberOfSubs+1}`}>   \n        {\n          !message\n            ? largeTiles\n            : null /* Avoid showing large tiles to make room for the message */\n        }\n      </div>\n      <div className=\"small-tiles\">{smallTiles}</div>\n      {message && (\n        <CallMessage\n          header={message.header}\n          detail={message.detail}\n          isError={message.isError}\n        />\n      )}\n    </div>\n  );\n}\n"]},"metadata":{},"sourceType":"module"}